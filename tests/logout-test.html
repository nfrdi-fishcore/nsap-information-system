<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logout Test Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            padding: 50px;
            font-family: Arial, sans-serif;
        }

        .test-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1><i class="bi bi-bug"></i> Logout Functionality Test</h1>
        <p>This page helps diagnose logout button issues.</p>

        <!-- Test 1: Check if components.js is loaded -->
        <div class="test-section">
            <h3>Test 1: Components.js Loaded</h3>
            <button class="btn btn-primary" onclick="test1()">Run Test</button>
            <div id="test1-result"></div>
        </div>

        <!-- Test 2: Check if sidebar can be inserted -->
        <div class="test-section">
            <h3>Test 2: Insert Sidebar Component</h3>
            <button class="btn btn-primary" onclick="test2()">Run Test</button>
            <div id="test2-result"></div>
            <div id="sidebarTest"></div>
        </div>

        <!-- Test 3: Check if logout button exists -->
        <div class="test-section">
            <h3>Test 3: Logout Button Exists</h3>
            <button class="btn btn-primary" onclick="test3()">Run Test</button>
            <div id="test3-result"></div>
        </div>

        <!-- Test 4: Test logout button click -->
        <div class="test-section">
            <h3>Test 4: Logout Button Click Event</h3>
            <button class="btn btn-primary" onclick="test4()">Run Test</button>
            <div id="test4-result"></div>
        </div>

        <!-- Test 5: Check Supabase -->
        <div class="test-section">
            <h3>Test 5: Supabase Client</h3>
            <button class="btn btn-primary" onclick="test5()">Run Test</button>
            <div id="test5-result"></div>
        </div>

        <!-- Manual Logout Test -->
        <div class="test-section">
            <h3>Manual Logout Test</h3>
            <button class="btn btn-danger" onclick="manualLogout()">
                <i class="bi bi-box-arrow-right"></i> Test Logout
            </button>
            <div id="manual-result"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/js/script.js"></script>
    <script src="assets/js/components.js"></script>

    <script>
        function showResult(testId, message, type) {
            const resultDiv = document.getElementById(testId);
            resultDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function test1() {
            if (typeof Components !== 'undefined') {
                showResult('test1-result', '✅ Components object is loaded!', 'success');
            } else {
                showResult('test1-result', '❌ Components object not found! Check if components.js is loaded.', 'error');
            }
        }

        function test2() {
            try {
                Components.insert('sidebar', '#sidebarTest');
                showResult('test2-result', '✅ Sidebar component inserted!', 'success');
            } catch (error) {
                showResult('test2-result', `❌ Error inserting sidebar: ${error.message}`, 'error');
            }
        }

        function test3() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                showResult('test3-result', `✅ Logout button found! ID: ${logoutBtn.id}`, 'success');
            } else {
                showResult('test3-result', '❌ Logout button not found! Run Test 2 first.', 'error');
            }
        }

        function test4() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (!logoutBtn) {
                showResult('test4-result', '❌ Logout button not found! Run Test 2 first.', 'error');
                return;
            }

            // Check if event listener is attached
            const listeners = getEventListeners ? getEventListeners(logoutBtn) : null;
            if (listeners && listeners.click && listeners.click.length > 0) {
                showResult('test4-result', `✅ Click event listener attached! (${listeners.click.length} listener(s))`, 'success');
            } else {
                showResult('test4-result', '⚠️ Cannot verify event listeners (use browser DevTools). Try clicking the logout button manually.', 'info');
            }
        }

        function test5() {
            if (typeof window._supabase !== 'undefined') {
                showResult('test5-result', '✅ Supabase client is initialized!', 'success');
            } else {
                showResult('test5-result', '❌ Supabase client not found! Check if script.js is loaded.', 'error');
            }
        }

        async function manualLogout() {
            const resultDiv = document.getElementById('manual-result');
            resultDiv.innerHTML = '<div class="status info">⏳ Testing logout...</div>';

            try {
                // Simulate the logout process
                console.log('Starting logout test...');

                if (window._supabase) {
                    console.log('Supabase found, signing out...');
                    const { error } = await window._supabase.auth.signOut();
                    if (error) {
                        throw new Error(`Supabase logout failed: ${error.message}`);
                    }
                    console.log('Supabase sign out successful');
                }

                // Clear localStorage
                console.log('Clearing localStorage...');
                localStorage.removeItem('userSession');
                localStorage.removeItem('rememberMe');
                localStorage.removeItem('sidebarCollapsed');

                // Clear sessionStorage
                console.log('Clearing sessionStorage...');
                sessionStorage.clear();

                resultDiv.innerHTML = '<div class="status success">✅ Logout test successful! Check console for details.</div>';

                setTimeout(() => {
                    resultDiv.innerHTML += '<div class="status info">ℹ️ In production, you would be redirected to login.html now.</div>';
                }, 1000);

            } catch (error) {
                console.error('Logout test error:', error);
                resultDiv.innerHTML = `<div class="status error">❌ Logout test failed: ${error.message}</div>`;
            }
        }

        // Auto-run Test 1 on load
        window.addEventListener('DOMContentLoaded', () => {
            test1();
        });
    </script>
</body>

</html>